<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Studio Calculator + Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .custom-radio:checked + div { 
            border-color: #7E73FD; 
            background-color: #eff6ff; 
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
        }

        .check-icon {
            background-color: #ffffff;
            border-color: #cbd5e1;
            color: transparent;
            transition: all 0.2s ease;
        }

        .custom-radio:checked + div .check-icon { 
            background-color: #7E73FD;
            border-color: #7E73FD;
            color: #ffffff;
            transform: scale(1.1);
        }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #2563EB;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden relative">

<div id="app-loader" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center gap-4">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <div class="text-slate-500 text-sm font-medium">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∞–∑–æ–π...</div>
</div>

<header class="bg-white border-b border-slate-200 py-4 px-6 flex justify-between items-center shadow-sm z-30 relative shrink-0">
    <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xl shadow-blue-200 shadow-lg">
            <i class="fas fa-calculator"></i>
        </div>
        <div>
            <h1 class="font-bold text-lg leading-tight text-slate-800">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –°–º–µ—Ç—ã</h1>
            <p class="text-xs text-slate-500 font-medium">–°—Ç—É–¥–∏–π–Ω—ã–π —Ä–∞—Å—á–µ—Ç</p>
        </div>
    </div>
    <div class="flex items-center gap-6">
        <div class="text-right hidden sm:block">
            <div class="text-xs text-slate-400 font-medium uppercase tracking-wider">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</div>
            <div class="text-2xl font-extrabold text-blue-600 tracking-tight" id="header-total">0 ‚ÇΩ</div>
        </div>
        <button onclick="toggleAdmin()" class="text-slate-300 hover:text-slate-600 transition-colors" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </div>
</header>

<main id="main-view" class="flex-1 flex overflow-hidden relative transition-opacity duration-300">
    <!-- LEFT: Settings -->
    <div class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8 pb-32 max-w-4xl mx-auto w-full" id="form-container"></div>

    <!-- RIGHT: Receipt -->
    <div class="w-96 bg-white border-l border-slate-200 flex flex-col shadow-[0_0_40px_-10px_rgba(0,0,0,0.1)] z-20 hidden lg:flex">
        <div class="p-5 border-b border-slate-100 bg-slate-50/50 backdrop-blur-sm shrink-0">
            <h2 class="font-bold text-slate-700 flex items-center gap-2 text-sm uppercase tracking-wide">
                <i class="fas fa-list-ul text-blue-500"></i> –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è
            </h2>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scroll p-5 min-h-0" id="receipt-list">
            <div class="h-full flex flex-col items-center justify-center text-slate-400 opacity-60">
                <i class="fas fa-calculator text-4xl mb-4 text-slate-200"></i>
                <p class="text-sm text-center">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ª–µ–≤–∞,<br>—á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞—Å—á–µ—Ç</p>
            </div>
        </div>

        <div class="border-t border-slate-200 bg-slate-50 shrink-0">
            <button onclick="toggleTeamView()" class="w-full px-5 py-3 flex justify-between items-center text-xs font-bold uppercase text-slate-500 hover:bg-slate-100 hover:text-slate-700 transition-colors">
                <div class="flex items-center gap-2">
                    <i class="fas fa-users"></i>
                    <span>–ë—é–¥–∂–µ—Ç (100%)</span>
                    <span id="active-preset-badge" class="ml-2 px-2 py-0.5 rounded bg-blue-100 text-blue-700 text-[10px] font-mono">--</span>
                </div>
                <i class="fas fa-chevron-up transition-transform" id="team-toggle-icon"></i>
            </button>
            <div id="team-distribution-panel" class="px-5 pb-4 hidden border-t border-dashed border-slate-200">
                <div id="team-list" class="space-y-2 mt-3"></div>
            </div>
        </div>

        <div class="p-5 border-t border-slate-200 bg-white shrink-0">
            <div class="flex justify-between items-end mb-4">
                <span class="text-sm font-medium text-slate-500">–ö –æ–ø–ª–∞—Ç–µ:</span>
                <span class="text-3xl font-extrabold text-slate-900" id="sidebar-total">0 ‚ÇΩ</span>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="copyEstimate()" class="col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-blue-200">
                    <i class="fas fa-copy"></i> –ö–ü
                </button>
                <button onclick="softReset()" class="col-span-1 bg-white border border-slate-200 text-slate-500 hover:bg-red-50 hover:text-red-500 hover:border-red-200 font-semibold py-3 px-4 rounded-xl transition-colors text-sm flex items-center justify-center shadow-sm">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    </div>
</main>

<div id="admin-panel" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex justify-end">
    <div class="bg-white w-full max-w-2xl h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="admin-content">
        <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
            <div>
                <h2 class="text-xl font-bold text-slate-800">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
                <p class="text-sm text-slate-500">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π Supabase (–¢–∞–±–ª–∏—Ü—ã)</p>
            </div>
            <button onclick="toggleAdmin()" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-500 hover:text-red-500 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-5">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-blue-900 flex items-center gap-2"><i class="fas fa-layer-group"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ü—Ä–µ—Å–µ—Ç–∞</h3>
                    <select id="admin-weight-context" onchange="switchAdminWeightContext(this.value)" class="text-sm border border-blue-200 bg-white text-slate-700 rounded px-3 py-1 font-bold outline-none cursor-pointer hover:border-blue-400 transition shadow-sm w-48"></select>
                </div>
                <p class="text-xs text-blue-700">–ü—Ä–æ—Ü–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã <b>project_presets</b>.</p>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-percentage text-purple-500"></i> –†–æ–ª–∏ –∏ –î–æ–ª–∏ (%)</h3>
                    <div class="text-sm font-mono bg-slate-100 px-3 py-1 rounded">–°—Ç—É–¥–∏—è: <span id="admin-studio-remainder" class="font-bold text-slate-700">--</span>%</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                            <tr>
                                <th class="px-3 py-2">ID</th>
                                <th class="px-3 py-2">–†–æ–ª—å</th>
                                <th class="px-3 py-2">–ü—Ä–æ—Ü–µ–Ω—Ç</th>
                                <th class="px-3 py-2 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="admin-roles-list"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-3 pt-3 border-t border-slate-100">
                    <div class="flex items-center gap-2 w-full">
                         <input type="text" id="new-role-id" placeholder="id (–ª–∞—Ç)" class="border border-slate-200 rounded px-2 py-1 text-xs w-20 outline-none">
                         <input type="text" id="new-role-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="border border-slate-200 rounded px-2 py-1 text-xs w-full outline-none">
                         <button onclick="addNewRoleSystem()" class="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 font-bold whitespace-nowrap">+ –°–æ–∑–¥–∞—Ç—å –†–æ–ª—å</button>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-link text-green-500"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏ (–ê–≤—Ç–æ-–ø–æ–¥–±–æ—Ä)</h3>
                <p class="text-xs text-slate-400 mb-4">–î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã <b>service_mappings</b>:</p>
                <div id="admin-mappings-list" class="space-y-3"></div>
            </div>
        </div>

        <div class="p-6 border-t border-slate-200 bg-slate-50 flex justify-end gap-3">
            <button onclick="toggleAdmin()" class="px-4 py-2 text-slate-500 hover:text-slate-800 font-medium transition-colors">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="saveConfigToSupabase()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md flex items-center gap-2">
                <i class="fas fa-cloud-upload-alt"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –í—Å–µ
            </button>
        </div>
    </div>
</div>

<!-- Custom Delete Modal -->
<div id="delete-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
        <div class="text-center mb-6">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-xl"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å –Ω–∞–≤—Å–µ–≥–¥–∞?</h3>
            <p class="text-sm text-slate-500">–≠—Ç–æ —É–¥–∞–ª–∏—Ç —Ä–æ–ª—å –∏–∑ –ë–î, –∞ —Ç–∞–∫–∂–µ –≤—Å–µ –µ—ë –ø—Ä–æ—Ü–µ–Ω—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</p>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <button onclick="closeDeleteModal()" class="py-2 px-4 bg-slate-100 rounded-lg hover:bg-slate-200">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="confirmDeleteRole()" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 translate-y-24 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 flex items-center gap-3 z-[100] pointer-events-none opacity-0">
    <i class="fas fa-check-circle text-green-400"></i>
    <span id="toast-msg" class="font-medium">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
</div>

<script>
    const PROJECT_URL = 'https://lwzqyykvosxvtzdgzvcj.supabase.co';
    const PUBLIC_KEY = 'sb_publishable_5qnLOWIqZ2SujmlVBwv0mA_2HciRaNX';
    const sb = supabase.createClient(PROJECT_URL, PUBLIC_KEY);

    // Initial Empty State
    let appConfig = { roles: [], presets: {}, mappings: {} };
    let state = { selected: {}, quantities: {}, discount: 0, totalForTeam: 0 };
    let currentAdminContext = 'landing';
    let roleToDeleteIdx = null;

    const services = [
        { id: "project_type", title: "1. –¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞", icon: "fa-rocket", type: "radio", options: [
            { id: "landing", label: "Landing Page", price: 8500 },
            { id: "wiki", label: "Wiki / Docs", price: 10000 },
            { id: "shop", label: "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω", price: 15000 },
            { id: "forum", label: "–§–æ—Ä—É–º", price: 15000 },
            { id: "corporate", label: "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç", price: 25000 }
        ]},
        { id: "design_tier", title: "2. –î–∏–∑–∞–π–Ω –∏ UI/UX", icon: "fa-palette", type: "radio", options: [
            { id: "tpl", label: "–®–∞–±–ª–æ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ", price: 5000 },
            { id: "clean", label: "–ë–∞–∑–æ–≤—ã–π –¥–∏–∑–∞–π–Ω", price: 10000 },
            { id: "medium", label: "–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –¥–∏–∑–∞–π–Ω", price: 15000 },
            { id: "wow", label: "–ü—Ä–µ–º–∏—É–º (WOW)", price: 45000 }
        ]},
        { id: "cms", title: "3. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ (CMS)", icon: "fa-server", type: "radio", options: [
            { id: "nocode", label: "Tilda (No-code)", price: 2500 },
            { id: "wp", label: "WordPress", price: 5000 },
            { id: "wpplus", label: "WordPress + Custom", price: 6500 },
            { id: "code", label: "Code (Basic)", price: 10000 },
            { id: "codeplus", label: "Code (Advanced)", price: 25000 }
        ]},
        { id: "content", title: "4. –ö–æ–Ω—Ç–µ–Ω—Ç", icon: "fa-file-signature", type: "qty_inputs", inputs: [
            { id: "pages", label: "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç—Ä.", price: 450, unit: "—Å—Ç—Ä." },
        ]},
        { id: "features", title: "5. –§—É–Ω–∫—Ü–∏–∏", icon: "fa-puzzle-piece", type: "checkbox", options: [
            { id: "form_calc", label: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", price: 3500 },
            { id: "quiz", label: "–ö–≤–∏–∑", price: 2000 },
            { id: "delivery", label: "–î–æ—Å—Ç–∞–≤–∫–∞ API", price: 9000 },
            { id: "application", label: "–§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏", price: 2500 }
        ]},
        { id: "marketing", title: "6. –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", icon: "fa-bullhorn", type: "checkbox", options: [
            { id: "seo", label: "SEO –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è", price: 25000 },
            { id: "copy", label: "–ö–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥", price: 2500 },
            { id: "analytics", label: "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞", price: 8500 }
        ]},
        { id: "conditions", title: "7. –£—Å–ª–æ–≤–∏—è", icon: "fa-stopwatch", type: "checkbox", options: [
            { id: "urgent", label: "–°—Ä–æ—á–Ω–æ—Å—Ç—å (x1.3)", price: 1.3, isMultiplier: true }
        ]},
        { id: "discount", title: "8. –°–∫–∏–¥–∫–∞", icon: "fa-tags", type: "range", min: 0, max: 50, step: 1, unit: "%" }
    ];

    /* =========================================
       INIT & DATA FETCH (RELATIONAL)
       ========================================= */
    async function init() {
        document.getElementById('app-loader').style.display = 'flex';
        try {
            // Fetch All Tables in parallel
            const [rolesRes, presetsRes, mappingsRes] = await Promise.all([
                sb.from('project_roles').select('*'),
                sb.from('project_presets').select('*'),
                sb.from('service_mappings').select('*')
            ]);

            // 1. Process Roles
            appConfig.roles = rolesRes.data || [];

            // 2. Process Presets (Convert Array -> Object)
            appConfig.presets = {};
            (presetsRes.data || []).forEach(row => {
                if (!appConfig.presets[row.preset_id]) appConfig.presets[row.preset_id] = {};
                appConfig.presets[row.preset_id][row.role_id] = row.percent;
            });

            // 3. Process Mappings (Convert Array -> Object)
            appConfig.mappings = {};
            (mappingsRes.data || []).forEach(row => {
                if (!appConfig.mappings[row.service_id]) appConfig.mappings[row.service_id] = [];
                appConfig.mappings[row.service_id].push(row.role_id);
            });

            console.log("Loaded normalized data:", appConfig);

        } catch (e) {
            console.error("DB Error:", e);
        } finally {
            document.getElementById('app-loader').style.display = 'none';
        }

        // Set default selection
        const firstProj = services[0].options[0];
        if (appConfig.roles.length > 0) {
            state.selected[firstProj.id] = { price: firstProj.price, isMult: false, label: firstProj.label, sectionId: 'project_type', id: firstProj.id };
        }
        
        renderCalculator();
        setTimeout(() => {
             const el = document.getElementById('opt_' + firstProj.id);
             if(el) el.checked = true;
             calculateTotal();
        }, 100);
    }

    // ... (renderCalculator, renderOptionHTML, renderQtyHTML, renderRangeHTML, Handlers remain identical) ...
    function renderCalculator() {
        const container = document.getElementById('form-container');
        container.innerHTML = '';
        services.forEach((section) => {
            let contentHTML = '';
            if (section.type === 'radio' || section.type === 'checkbox') {
                contentHTML = section.options.map(opt => renderOptionHTML(section, opt)).join('');
            } else if (section.type === 'qty_inputs') {
                contentHTML = section.inputs.map(inp => renderQtyHTML(inp)).join('');
            } else if (section.type === 'range') {
                contentHTML = renderRangeHTML(section);
            }
            container.insertAdjacentHTML('beforeend', `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
                    <div class="w-full px-6 py-5 flex items-center justify-between bg-white border-b border-slate-100">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-lg"><i class="fas ${section.icon}"></i></div>
                            <span class="font-bold text-lg text-slate-700">${section.title}</span>
                        </div>
                    </div>
                    <div class="px-6 pb-6 pt-4"><div class="grid grid-cols-1 gap-3 pt-2">${contentHTML}</div></div>
                </div>
            `);
        });
    }
    function renderOptionHTML(section, opt) {
        const inputType = section.type;
        const nameAttr = section.type === 'radio' ? `name="${section.id}"` : '';
        const shapeClass = inputType === 'radio' ? 'rounded-full' : 'rounded-md';
        let priceTag = opt.isMultiplier 
            ? `<span class="text-amber-600 font-bold bg-amber-50 px-2 py-1 rounded text-xs">+${Math.round((opt.price-1)*100)}%</span>` 
            : `<span class="text-slate-500 font-medium text-sm">+${opt.price.toLocaleString()} ‚ÇΩ</span>`;
        return `<label class="cursor-pointer relative block"><input type="${inputType}" ${nameAttr} id="opt_${opt.id}" class="peer sr-only custom-radio" onchange="handleOptionChange('${section.id}', '${opt.id}', '${inputType}', ${opt.price}, ${opt.isMultiplier||false}, '${opt.label}')"><div class="p-4 rounded-xl border border-slate-200 hover:border-blue-400 bg-white flex justify-between items-center transition-all duration-200"><div class="flex items-center gap-3"><div class="w-6 h-6 ${shapeClass} border-2 border-slate-300 flex items-center justify-center check-icon shrink-0 shadow-sm"><i class="fas fa-check text-xs"></i></div><div><div class="font-semibold text-slate-800 leading-tight">${opt.label}</div></div></div><div>${priceTag}</div></div></label>`;
    }
    function renderQtyHTML(inp) {
        return `<div class="p-4 rounded-xl border border-slate-200 bg-slate-50/50 flex flex-col sm:flex-row sm:items-center justify-between gap-4"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-200 text-slate-500 flex items-center justify-center text-xs"><i class="fas fa-times"></i></div><div><div class="font-medium text-slate-800">${inp.label}</div><div class="text-xs text-slate-400">${inp.price} ‚ÇΩ / ${inp.unit}</div></div></div><div class="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-300 shadow-sm"><button onclick="changeQtyValue('${inp.id}', -1)" class="w-8 h-8 rounded hover:bg-slate-100 text-slate-600 font-bold">-</button><input type="number" id="qty_input_${inp.id}" value="0" min="0" class="w-12 text-center font-bold text-slate-800 outline-none" oninput="handleQtyChange('${inp.id}', this.value, ${inp.price}, '${inp.label}', '${inp.unit}')"><button onclick="changeQtyValue('${inp.id}', 1)" class="w-8 h-8 rounded hover:bg-blue-50 text-blue-600 font-bold">+</button></div></div>`;
    }
    function renderRangeHTML(section) {
        return `<div class="p-4 bg-slate-50 rounded-xl border border-slate-200"><div class="flex justify-between items-center mb-2"><label class="font-medium text-slate-700">–†–∞–∑–º–µ—Ä —Å–∫–∏–¥–∫–∏</label><span class="font-bold text-blue-600 text-lg bg-blue-50 px-3 py-1 rounded-lg border border-blue-100" id="range_val_${section.id}">0%</span></div><input type="range" id="range_${section.id}" min="${section.min}" max="${section.max}" step="${section.step}" value="0" oninput="handleRangeChange(this.value, '${section.id}')"></div>`;
    }
    window.handleOptionChange = function(sectionId, optId, type, price, isMult, label) {
        if (type === 'radio') {
            const section = services.find(s => s.id === sectionId);
            section.options.forEach(o => delete state.selected[o.id]);
        }
        if (document.getElementById('opt_' + optId).checked) {
            state.selected[optId] = { price, isMult, label, sectionId, id: optId };
        } else {
            delete state.selected[optId];
        }
        calculateTotal();
    }
    window.handleQtyChange = function(id, val, price, label, unit) {
        const v = parseInt(val) || 0;
        v > 0 ? state.quantities[id] = { qty: v, price, label, unit } : delete state.quantities[id];
        calculateTotal();
    }
    window.changeQtyValue = function(id, delta) {
        const inp = document.getElementById(`qty_input_${id}`);
        inp.value = Math.max(0, (parseInt(inp.value) || 0) + delta);
        inp.dispatchEvent(new Event('input'));
    }
    window.handleRangeChange = function(v, id) {
        state.discount = parseInt(v) || 0;
        document.getElementById(`range_val_${id}`).innerText = v + '%';
        calculateTotal();
    }

    function calculateTeamDistribution() {
        const projSection = services.find(s => s.id === 'project_type');
        let activeProjectId = null;
        let activeProjectLabel = '–ù–µ –≤—ã–±—Ä–∞–Ω';
        if (projSection) {
            for(const opt of projSection.options) {
                if (state.selected[opt.id]) {
                    activeProjectId = opt.id;
                    activeProjectLabel = opt.label;
                    break;
                }
            }
        }
        const badge = document.getElementById('active-preset-badge');
        badge.classList.remove('hidden');
        badge.innerText = `${activeProjectLabel}`;

        const activeRoleIds = new Set();
        for (const [key, item] of Object.entries(state.selected)) {
            const mapped = appConfig.mappings ? appConfig.mappings[item.id] : [];
            if (mapped) mapped.forEach(rId => activeRoleIds.add(rId));
        }

        let presetPercents = {};
        if (activeProjectId && appConfig.presets && appConfig.presets[activeProjectId]) {
            presetPercents = appConfig.presets[activeProjectId];
        }
        
        let usedPercent = 0;
        const currentRoles = appConfig.roles || [];
        const calculatedRoles = currentRoles.filter(r => activeRoleIds.has(r.id)).map(r => {
            const percent = presetPercents[r.id] || 0;
            usedPercent += percent;
            return { ...r, percent };
        });

        const studioPercent = Math.max(0, 100 - usedPercent);
        const teamListEl = document.getElementById('team-list');
        teamListEl.innerHTML = '';
        renderTeamRow('studio', '–°—Ç—É–¥–∏—è', studioPercent, true, teamListEl, true);
        calculatedRoles.forEach(role => {
            renderTeamRow(role.id, role.name, role.percent, false, teamListEl, false);
        });
        
        if (!activeProjectId) {
            teamListEl.innerHTML = `<div class="text-xs text-center text-slate-400 py-2">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞</div>`;
        } else if (Object.keys(presetPercents).length === 0 && currentRoles.length > 0) {
             teamListEl.innerHTML += `<div class="text-[10px] text-center text-red-400 py-1">–ü—Ä–µ—Å–µ—Ç "${activeProjectLabel}" –ø—É—Å—Ç. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –∞–¥–º–∏–Ω–∫–µ.</div>`;
        }
        updateTeamCalculations();
    }

    function renderTeamRow(id, name, percent, isStudio, container, isHighlight) {
        const row = document.createElement('div');
        row.className = `flex justify-between items-center text-sm py-1 ${isHighlight ? 'mb-2 pb-2 border-b border-dashed border-slate-200' : ''}`;
        row.innerHTML = `
            <div class="flex items-center gap-2 text-slate-600"><span class="${isStudio ? 'font-bold text-blue-600' : ''}">${name}</span></div>
            <div class="flex items-center gap-2">
                <div class="bg-slate-100 rounded px-2 py-1 text-xs font-mono text-slate-500 w-24 text-right money-val" id="money_${id}">0 ‚ÇΩ</div>
                <div class="flex items-center bg-white border border-slate-200 rounded px-2 py-1 gap-1 w-16 justify-center ${isStudio ? 'bg-blue-50 border-blue-200 text-blue-700 font-bold' : ''}">
                    <span class="text-xs font-bold">${percent}</span><span class="text-[10px] text-slate-400">%</span>
                </div>
            </div>`;
        container.appendChild(row);
    }
    function updateTeamCalculations() {
        const total = state.totalForTeam;
        const moneyVals = document.querySelectorAll('.money-val');
        moneyVals.forEach(el => {
            const percentContainer = el.nextElementSibling;
            const percentVal = parseFloat(percentContainer.innerText) || 0;
            const amount = Math.round(total * (percentVal / 100));
            el.innerText = amount.toLocaleString() + ' ‚ÇΩ';
        });
    }

    /* =========================================
       ADMIN PANEL LOGIC (SAVE TO TABLES)
       ========================================= */
    window.toggleAdmin = function() {
        const panel = document.getElementById('admin-panel');
        const content = document.getElementById('admin-content');
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-x-full'), 10);
            populateAdminContextSelector();
            populateAdminPanel();
        } else {
            content.classList.add('translate-x-full');
            setTimeout(() => panel.classList.add('hidden'), 300);
        }
    }
    function populateAdminContextSelector() {
        const sel = document.getElementById('admin-weight-context');
        sel.innerHTML = '';
        services.find(s => s.id === 'project_type')?.options.forEach(opt => {
            sel.innerHTML += `<option value="${opt.id}" ${currentAdminContext === opt.id ? 'selected' : ''}>üìÇ ${opt.label}</option>`;
        });
        if (!sel.querySelector(`option[value="${currentAdminContext}"]`)) {
             currentAdminContext = services.find(s => s.id === 'project_type').options[0].id;
        }
        sel.value = currentAdminContext;
    }
    window.switchAdminWeightContext = function(val) { currentAdminContext = val; populateAdminPanel(); }

    function populateAdminPanel() {
        const rolesTbody = document.getElementById('admin-roles-list');
        rolesTbody.innerHTML = '';
        if (!appConfig.presets) appConfig.presets = {};
        if (!appConfig.presets[currentAdminContext]) appConfig.presets[currentAdminContext] = {};
        let totalAssigned = 0;

        appConfig.roles.forEach((role, idx) => {
            let val = appConfig.presets[currentAdminContext][role.id];
            if (val === undefined) val = 0; 
            totalAssigned += val;
            const deleteBtn = `<button onclick="deleteRoleSystem(${idx})" class="text-red-300 hover:text-red-500" title="–£–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å –ù–ê–í–°–ï–ì–î–ê"><i class="fas fa-trash"></i></button>`;
            rolesTbody.innerHTML += `<tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50"><td class="px-3 py-2 text-xs font-mono text-slate-400">${role.id}</td><td class="px-3 py-2 text-sm font-medium text-slate-700"><input type="text" value="${role.name}" class="bg-transparent outline-none w-full" onchange="updateRoleName(${idx}, this.value)"></td><td class="px-3 py-2"><input type="number" min="0" max="100" value="${val}" class="w-20 bg-blue-50 border border-blue-200 rounded text-center font-bold text-blue-800 outline-none focus:border-blue-500" onchange="updatePresetPercent('${role.id}', this.value)"></td><td class="px-3 py-2 text-right">${deleteBtn}</td></tr>`;
        });
        document.getElementById('admin-studio-remainder').innerText = 100 - totalAssigned;
        populateMappings();
    }

    window.updateRoleName = function(idx, newName) { appConfig.roles[idx].name = newName; }
    window.updatePresetPercent = function(roleId, val) {
        let floatVal = parseFloat(val); if (isNaN(floatVal)) floatVal = 0;
        appConfig.presets[currentAdminContext][roleId] = floatVal;
        populateAdminPanel();
    }
    window.addNewRoleSystem = function() {
        const id = document.getElementById('new-role-id').value.trim();
        const name = document.getElementById('new-role-name').value.trim();
        if (!id || !name) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∏ –ù–∞–∑–≤–∞–Ω–∏–µ");
        if (appConfig.roles.find(r => r.id === id)) return alert("ID –∑–∞–Ω—è—Ç");
        appConfig.roles.push({ id, name });
        populateAdminPanel();
        document.getElementById('new-role-id').value = '';
        document.getElementById('new-role-name').value = '';
    }
    
    // Deletion Logic
    window.deleteRoleSystem = function(idx) { roleToDeleteIdx = idx; document.getElementById('delete-modal').classList.remove('hidden'); }
    window.closeDeleteModal = function() { roleToDeleteIdx = null; document.getElementById('delete-modal').classList.add('hidden'); }
    window.confirmDeleteRole = function() {
        if (roleToDeleteIdx === null) return;
        const idx = roleToDeleteIdx;
        const roleId = appConfig.roles[idx].id;
        appConfig.roles.splice(idx, 1);
        
        // Clean JS state
        for (const pid in appConfig.presets) delete appConfig.presets[pid][roleId];
        for (const sid in appConfig.mappings) appConfig.mappings[sid] = appConfig.mappings[sid].filter(id => id !== roleId);
        
        populateAdminPanel();
        closeDeleteModal();
    }

    // Mappings
    function populateMappings() {
        const mapList = document.getElementById('admin-mappings-list');
        mapList.innerHTML = '';
        let allOptions = [];
        services.forEach(s => { if (s.options) s.options.forEach(o => allOptions.push(o)); });
        allOptions.forEach(opt => {
            const currentRoles = appConfig.mappings ? (appConfig.mappings[opt.id] || []) : [];
            let roleSelects = appConfig.roles.map(r => `<option value="${r.id}" ${currentRoles.includes(r.id) ? 'selected' : ''}>${r.name}</option>`).join('');
            mapList.innerHTML += `<div class="flex items-center justify-between border-b border-slate-100 pb-2"><span class="text-sm font-medium text-slate-700 w-1/3">${opt.label}</span><div class="w-2/3"><select multiple onchange="updateMapping('${opt.id}', this)" class="w-full border border-slate-200 rounded p-1 text-xs h-16 bg-slate-50">${roleSelects}</select></div></div>`;
        });
    }
    window.updateMapping = function(optId, el) {
        if (!appConfig.mappings) appConfig.mappings = {};
        appConfig.mappings[optId] = Array.from(el.selectedOptions).map(o => o.value);
    }

    // --- MAIN CALCULATOR ---
    function calculateTotal() {
        let sum = 0, mult = 1, html = '', hasItems = false;
        const receipt = document.getElementById('receipt-list');
        for (const k in state.selected) {
            const item = state.selected[k];
            if (item.isMult) mult *= item.price;
            else { sum += item.price; html += rowHTML(item.label, item.price); hasItems = true; }
        }
        for (const k in state.quantities) {
            const q = state.quantities[k];
            const cost = q.qty * q.price;
            sum += cost;
            html += rowHTML(`${q.label} <span class="text-xs text-slate-400">x${q.qty}</span>`, cost);
            hasItems = true;
        }
        for (const k in state.selected) {
            if (state.selected[k].isMult) html += `<div class="flex justify-between py-2 border-b border-dashed border-slate-200 text-amber-600"><span class="text-sm">‚ö° ${state.selected[k].label}</span><span class="font-bold text-xs">+${Math.round((state.selected[k].price-1)*100)}%</span></div>`;
        }
        let total = Math.round(sum * mult);
        if (state.discount > 0) {
            const dVal = Math.round(total * (state.discount/100));
            total -= dVal;
            html += `<div class="flex justify-between py-3 border-t border-slate-100 text-green-600 bg-green-50/50 -mx-5 px-5 mt-2"><span class="text-sm font-bold">–°–∫–∏–¥–∫–∞</span><span class="font-bold text-sm">-${dVal.toLocaleString()} ‚ÇΩ</span></div>`;
        }
        if(!hasItems && mult===1) receipt.innerHTML = `<div class="h-full flex items-center justify-center text-slate-400 opacity-60"><p class="text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏</p></div>`;
        else receipt.innerHTML = html;
        ['header-total','sidebar-total'].forEach(id => document.getElementById(id).innerText = total.toLocaleString() + ' ‚ÇΩ');
        state.totalForTeam = total;
        calculateTeamDistribution();
    }
    function rowHTML(n, p) { return `<div class="flex justify-between py-2 border-b border-slate-100 last:border-0"><span class="text-sm w-2/3">${n}</span><span class="text-sm font-bold text-blue-600">${p.toLocaleString()} ‚ÇΩ</span></div>`; }
    window.softReset = function() {
        state = { selected: {}, quantities: {}, discount: 0, totalForTeam: 0 };
        document.querySelectorAll('input').forEach(i => {
            if(i.type==='checkbox'||i.type==='radio') i.checked=false;
            else if(i.type==='number' && !i.id.includes('percent')) i.value=0;
            else if(i.type==='range') { i.value=0; document.getElementById('range_val_discount').innerText='0%'; }
        });
        const firstProj = services[0].options[0];
        document.getElementById('opt_' + firstProj.id).checked = true;
        state.selected[firstProj.id] = { price: firstProj.price, isMult: false, label: firstProj.label, sectionId: 'project_type', id: firstProj.id };
        calculateTotal();
    }
    window.copyEstimate = function() {
        const t = document.getElementById('sidebar-total').innerText;
        navigator.clipboard.writeText(`–ò–¢–û–ì–û: ${t}`).then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'));
    }

    /* =========================================
       SAVE TO RELATIONAL DB
       ========================================= */
    window.saveConfigToSupabase = async function() {
        const btn = document.querySelector('button[onclick="saveConfigToSupabase()"]');
        const oldTxt = btn.innerText;
        btn.innerText = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        try {
            // 1. Sync Roles (Upsert & Delete missing)
            // First, fetch current DB IDs to know what to delete
            const { data: dbRoles } = await sb.from('project_roles').select('id');
            const currentIds = appConfig.roles.map(r => r.id);
            const idsToDelete = dbRoles.filter(r => !currentIds.includes(r.id)).map(r => r.id);

            // Delete removed roles (CASCADE will handle presets/mappings)
            if (idsToDelete.length > 0) {
                await sb.from('project_roles').delete().in('id', idsToDelete);
            }
            // Upsert current roles
            await sb.from('project_roles').upsert(appConfig.roles);

            // 2. Sync Presets (Delete all and re-insert is safest for simple logic, 
            // but upsert is better. Let's do Upsert and clean old.
            // Since we deleted roles, their presets are gone. We just need to upsert new ones.)
            const presetRows = [];
            for (const pid in appConfig.presets) {
                for (const rid in appConfig.presets[pid]) {
                    if (appConfig.roles.find(r => r.id === rid)) { // Only if role exists
                        presetRows.push({ preset_id: pid, role_id: rid, percent: appConfig.presets[pid][rid] });
                    }
                }
            }
            if (presetRows.length > 0) await sb.from('project_presets').upsert(presetRows);

            // 3. Sync Mappings
            // We need to clear old mappings or upsert. Since mappings are simple key-pairs, 
            // deleting by service_id and re-inserting is clean.
            // Actually, we can just upsert. But if a role was removed from a service mapping in UI, upsert won't remove it.
            // So: Delete all mappings for known services, then insert.
            const serviceIds = Object.keys(appConfig.mappings);
            if (serviceIds.length > 0) {
                await sb.from('service_mappings').delete().in('service_id', serviceIds);
                const mappingRows = [];
                for (const sid in appConfig.mappings) {
                    appConfig.mappings[sid].forEach(rid => {
                        if (appConfig.roles.find(r => r.id === rid)) {
                            mappingRows.push({ service_id: sid, role_id: rid });
                        }
                    });
                }
                if (mappingRows.length > 0) await sb.from('service_mappings').insert(mappingRows);
            }

            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î!');
            toggleAdmin();
            calculateTeamDistribution(); // Refresh UI

        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message);
            console.error(e);
        } finally {
            btn.innerText = oldTxt;
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 3000);
    }

    init();
</script>
</body>
</html>
